name: ci

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  checks: write
  id-token: write

env:
  # Ensure Nx prints useful logs in CI
  NX_VERBOSE_LOGGING: false
  # Avoid Nx daemon issues in ephemeral runners
  NX_DAEMON: false

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Run lint
        run: |
          pnpm exec nx affected -t lint --parallel=3 --base=origin/main
  format:
    name: format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Prettier Check
        run: |
          npx prettier --version
          npx prettier --check .
  api-compare:
    name: api / compare
    runs-on: ubuntu-latest
    needs: [lint, format]
    # This job monitors WooCommerce Admin and Store API structures for breaking changes
    # It creates snapshots of the current API structure and compares against baselines
    # Any structural changes (new/removed endpoints, parameter changes) will be detected
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Start WordPress Environment
        run: |
          set -euo pipefail
          echo "Provisioning WordPress + WooCommerce for API structure monitoring..."
          npm run wp:env:up
      - name: Monitor Admin API Structure Changes
        env:
          WC_API_BASE_URL: http://localhost:8080
        run: |
          set -euo pipefail
          echo "üîç Checking WooCommerce Admin API structure for changes..."

          # Create current admin API snapshot
          node scripts/wc-admin-api-monitor.mjs --create --path=/wp-json/wc/v3

          # Check for changes against baseline (if baseline exists)
          if [ -f "snapshots/api-structure/admin/baseline.json" ]; then
            echo "Comparing against baseline..."
            node scripts/wc-admin-api-monitor.mjs --compare --path=/wp-json/wc/v3
          else
            echo "No baseline found - creating initial baseline"
            cp snapshots/api-structure/admin/current.json snapshots/api-structure/admin/baseline.json
          fi
      - name: Monitor Store API Structure Changes
        env:
          WC_API_BASE_URL: http://localhost:8080
        run: |
          set -euo pipefail
          echo "üîç Checking WooCommerce Store API structure for changes..."

          # Create current store API snapshot
          node scripts/wc-admin-api-monitor.mjs --create --path=/wp-json/wc/store/v1

          # Check for changes against baseline (if baseline exists)
          if [ -f "snapshots/api-structure/store/baseline.json" ]; then
            echo "Comparing against baseline..."
            node scripts/wc-admin-api-monitor.mjs --compare --path=/wp-json/wc/store/v1
          else
            echo "No baseline found - creating initial baseline"
            cp snapshots/api-structure/store/current.json snapshots/api-structure/store/baseline.json
          fi
      - name: Upload API Structure Snapshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-structure-snapshots-${{ github.run_id }}
          path: |
            snapshots/api-structure/
          retention-days: 30
      - name: API Structure Summary
        if: always()
        run: |
          echo "üìä API Structure Monitoring Summary:"
          echo "=================================="

          if [ -f "snapshots/api-structure/admin/current.json" ]; then
            ADMIN_ROUTES=$(node -e "console.log(Object.keys(JSON.parse(require('fs').readFileSync('snapshots/api-structure/admin/current.json', 'utf8')).routes).length)")
            echo "Admin API Routes: $ADMIN_ROUTES"
          fi

          if [ -f "snapshots/api-structure/store/current.json" ]; then
            STORE_ROUTES=$(node -e "console.log(Object.keys(JSON.parse(require('fs').readFileSync('snapshots/api-structure/store/current.json', 'utf8')).routes).length)")
            echo "Store API Routes: $STORE_ROUTES"
          fi

          echo "Snapshots saved as CI artifacts for 30 days"
      - name: Tear Down WordPress Environment
        if: always()
        run: npm run wp:env:clean || true
  test-unit:
    name: tests / unit
    runs-on: ubuntu-latest
    needs: [lint, format, api-compare]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Run Unit Tests (fast, no WP env)
        run: |
          cd packages/core && npx vitest run --coverage src/lib/tests/unit
  test:
    name: tests / integration & flow & plugin
    runs-on: ubuntu-latest
    needs: [lint, format, api-compare]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Start WordPress Environment
        run: |
          set -euo pipefail
          echo "Provisioning WordPress + WooCommerce for tests..."
          npm run wp:env:up
          npm run wp:cli:fast option get store_sdk_seeded || true
          npm run wp:cli:fast post list --post_type=product --posts_per_page=1 --format=json || true
      - name: Run WP Plugin Tests
        env:
          WP_URL: http://localhost:8080
        run: |
          npx vitest run scripts/tests
      - name: Run Integration Tests
        run: |
          cd packages/core && npx vitest run --coverage src/lib/tests/integration
      - name: Run Flow Tests
        run: |
          cd packages/core && npx vitest run --coverage src/lib/tests/flow
      - name: Tear Down WordPress Environment
        if: always()
        run: npm run wp:env:clean || true
  plugin-check:
    name: plugin / check
    runs-on: ubuntu-latest
    needs: [lint, format, api-compare]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Start WordPress Environment (minimal)
        run: |
          set -euo pipefail
          echo "Provisioning minimal WordPress for plugin check..."
          npm run wp:env:up:minimal
      - name: Run WordPress Plugin Check
        run: |
          set -euo pipefail
          echo "Running WordPress plugin check (errors only)..."

          # Run plugin check and capture output
          npm run wp:plugin:check:json > plugin-check-output.json || true

          # Parse JSON and check for errors (not warnings)
          if [ -f plugin-check-output.json ]; then
            # Count errors (type: "ERROR")
            ERROR_COUNT=$(jq '[.[] | select(.type == "ERROR")] | length' plugin-check-output.json 2>/dev/null || echo "0")
            
            echo "Plugin check completed:"
            echo "- Errors found: $ERROR_COUNT"
            
            # Show all results for visibility
            echo "Full plugin check results:"
            npm run wp:plugin:check || true
            
            # Only fail if there are actual errors
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "‚ùå Plugin check failed with $ERROR_COUNT error(s)"
              echo "Error details:"
              jq '[.[] | select(.type == "ERROR")]' plugin-check-output.json 2>/dev/null || echo "Failed to parse errors"
              exit 1
            else
              echo "‚úÖ Plugin check passed (no errors found, warnings are acceptable)"
            fi
          else
            echo "‚ö†Ô∏è Could not parse plugin check output, running basic check..."
            npm run wp:plugin:check
          fi
      - name: Tear Down WordPress Environment
        if: always()
        run: npm run wp:env:down || true
  build:
    name: build
    runs-on: ubuntu-latest
    needs: [lint, format, api-compare, test, test-unit, plugin-check]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: build (all projects)
        run: |
          npx nx affected -t build --parallel=3 --base=origin/main
      - name: Package Size Summary (optional)
        if: always()
        run: |
          find packages -maxdepth 3 -type f -name package.json -printf "\n---- %p ----\n" -exec jq -r '.name + "@" + (.version // "0.0.0")' {} \;
