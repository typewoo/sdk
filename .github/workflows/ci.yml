name: ci

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  checks: write
  id-token: write

env:
  # Ensure Nx prints useful logs in CI
  NX_VERBOSE_LOGGING: false
  # Avoid Nx daemon issues in ephemeral runners
  NX_DAEMON: false

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Run lint
        run: |
          pnpm exec nx affected -t lint --parallel=3 --base=origin/main
  format:
    name: format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Prettier Check
        run: |
          npx prettier --version
          npx prettier --check .
  test-unit:
    name: tests / unit
    runs-on: ubuntu-latest
    needs: [lint, format]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Run Unit Tests (fast, no WP env)
        run: |
          cd packages/core && npx vitest run --coverage src/lib/tests/unit
  test:
    name: tests / integration & flow & plugin
    runs-on: ubuntu-latest
    needs: [lint, format]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Start WordPress Environment
        run: |
          set -euo pipefail
          echo "Provisioning WordPress + WooCommerce for tests..."
          npm run wp:env:up
          npm run wp:cli:fast option get store_sdk_seeded || true
          npm run wp:cli:fast post list --post_type=product --posts_per_page=1 --format=json || true
      - name: Run WP Plugin Tests
        env:
          WP_URL: http://localhost:8080
        run: |
          npx vitest run --config scripts/tests/vitest.config.ts scripts/tests
      - name: Run Integration Tests
        run: |
          cd packages/core && npx vitest run --coverage src/lib/tests/integration
      - name: Run Flow Tests
        run: |
          cd packages/core && npx vitest run --coverage src/lib/tests/flow
      - name: Tear Down WordPress Environment
        if: always()
        run: npm run wp:env:clean || true
  plugin-check:
    name: plugin / check
    runs-on: ubuntu-latest
    needs: [lint, format]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Start WordPress Environment (minimal)
        run: |
          set -euo pipefail
          echo "Provisioning minimal WordPress for plugin check..."
          npm run wp:env:up:minimal
      - name: Run WordPress Plugin Check
        run: |
          set -euo pipefail
          echo "Running WordPress plugin check (errors only)..."

          # Run plugin check and capture output
          npm run wp:plugin:check:json > plugin-check-output.json || true

          # Parse JSON and check for errors (not warnings)
          if [ -f plugin-check-output.json ]; then
            # Count errors (type: "ERROR")
            ERROR_COUNT=$(jq '[.[] | select(.type == "ERROR")] | length' plugin-check-output.json 2>/dev/null || echo "0")
            
            echo "Plugin check completed:"
            echo "- Errors found: $ERROR_COUNT"
            
            # Show all results for visibility
            echo "Full plugin check results:"
            npm run wp:plugin:check || true
            
            # Only fail if there are actual errors
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "❌ Plugin check failed with $ERROR_COUNT error(s)"
              echo "Error details:"
              jq '[.[] | select(.type == "ERROR")]' plugin-check-output.json 2>/dev/null || echo "Failed to parse errors"
              exit 1
            else
              echo "✅ Plugin check passed (no errors found, warnings are acceptable)"
            fi
          else
            echo "⚠️ Could not parse plugin check output, running basic check..."
            npm run wp:plugin:check
          fi
      - name: Tear Down WordPress Environment
        if: always()
        run: npm run wp:env:down || true
  build:
    name: build
    runs-on: ubuntu-latest
    needs: [lint, format, test, test-unit, plugin-check]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: build (all projects)
        run: |
          npx nx affected -t build --parallel=3 --base=origin/main
      - name: Package Size Summary (optional)
        if: always()
        run: |
          find packages -maxdepth 3 -type f -name package.json -printf "\n---- %p ----\n" -exec jq -r '.name + "@" + (.version // "0.0.0")' {} \;
