name: WooCommerce API Structure Monitor

on:
  # Run on schedule every day at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      wp_url:
        description: 'WordPress URL to check (optional override)'
        required: false
        default: ''
        type: string

concurrency:
  group: api-monitor-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: 20
  NX_DAEMON: false
  # Default WordPress URL for API monitoring
  WC_API_BASE_URL: ${{ inputs.wp_url || 'http://localhost:8080' }}

jobs:
  api-structure-monitor:
    name: Monitor WC Admin & Store API Structure
    runs-on: ubuntu-latest
    outputs:
      admin-api-status: ${{ steps.admin-check.outputs.status }}
      store-api-status: ${{ steps.store-check.outputs.status }}
      admin-changes-detected: ${{ steps.admin-check.outputs.changes_detected }}
      store-changes-detected: ${{ steps.store-check.outputs.changes_detected }}

    # Only run if we have a WordPress environment or if manually triggered
    if: ${{ github.event.schedule || github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install Dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      - name: Setup WordPress Test Environment
        run: |
          # Start WordPress environment for API testing
          if [ -f "infra/wordpress/docker-compose.yml" ]; then
            echo "Starting WordPress test environment..."
            cd infra/wordpress
            docker-compose up -d --wait
            cd ../..
            
            # Wait for WordPress to be ready
            timeout 120 bash -c 'until curl -f ${{ env.WC_API_BASE_URL }}/wp-json/wc/v3; do sleep 5; done'
            echo "WordPress environment is ready"
          else
            echo "No WordPress docker-compose found, assuming external WordPress is available"
          fi

      - name: Check Admin API Baseline
        id: check-admin-baseline
        run: |
          if [ -f "snapshots/api-structure/admin/baseline.json" ]; then
            echo "admin_baseline_exists=true" >> $GITHUB_OUTPUT
          else
            echo "admin_baseline_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Store API Baseline
        id: check-store-baseline
        run: |
          if [ -f "snapshots/api-structure/store/baseline.json" ]; then
            echo "store_baseline_exists=true" >> $GITHUB_OUTPUT
          else
            echo "store_baseline_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Admin API Structure Changes
        if: ${{ steps.check-admin-baseline.outputs.admin_baseline_exists == 'true' }}
        id: admin-check
        run: |
          echo "Checking for Admin API structure changes..."
          if node scripts/wc-admin-api-monitor.mjs --compare --path=/wp-json/wc/v3; then
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "status=sync" >> $GITHUB_OUTPUT
            echo "âœ… No Admin API structure changes detected"
          else
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "status=out-of-sync" >> $GITHUB_OUTPUT
            echo "ðŸš¨ Admin API structure changes detected!"
          fi
        continue-on-error: true

      - name: Check Store API Structure Changes
        if: ${{ steps.check-store-baseline.outputs.store_baseline_exists == 'true' }}
        id: store-check
        run: |
          echo "Checking for Store API structure changes..."
          if node scripts/wc-admin-api-monitor.mjs --compare --path=/wp-json/wc/store/v1; then
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "status=sync" >> $GITHUB_OUTPUT
            echo "âœ… No Store API structure changes detected"
          else
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "status=out-of-sync" >> $GITHUB_OUTPUT
            echo "ðŸš¨ Store API structure changes detected!"
          fi
        continue-on-error: true

      - name: Upload API Snapshots as Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-structure-snapshots-${{ github.run_id }}
          path: |
            snapshots/api-structure/
          retention-days: 30

      - name: Cleanup WordPress Environment
        if: always()
        run: |
          if [ -f "infra/wordpress/docker-compose.yml" ]; then
            echo "Stopping WordPress test environment..."
            cd infra/wordpress
            docker-compose down -v
          fi

      - name: Summary
        if: always()
        run: |
          echo "## API Structure Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Admin API (/wp-json/wc/v3)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-admin-baseline.outputs.admin_baseline_exists }}" = "false" ]; then
            echo "âš ï¸ **No baseline exists** - Manual baseline creation required" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.admin-check.outputs.changes_detected }}" = "true" ]; then
            echo "ðŸš¨ **Changes detected!** Admin API structure has changed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **In Sync** - No changes detected" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Store API (/wp-json/wc/store/v1)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-store-baseline.outputs.store_baseline_exists }}" = "false" ]; then
            echo "âš ï¸ **No baseline exists** - Manual baseline creation required" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.store-check.outputs.changes_detected }}" = "true" ]; then
            echo "ðŸš¨ **Changes detected!** Store API structure has changed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **In Sync** - No changes detected" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:** API structure snapshots are available in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
